<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EcoLink - Emergency Cache Clear</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 600px;
        margin: 50px auto;
        padding: 20px;
        background: #f8fafc;
        color: #334155;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
      }
      h1 {
        color: #069e2d;
        margin-bottom: 20px;
      }
      .warning {
        background: #fef3c7;
        border: 1px solid #f59e0b;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
      }
      button {
        background: #069e2d;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        margin: 10px;
      }
      button:hover {
        background: #047857;
      }
      .secondary {
        background: #6b7280;
      }
      .secondary:hover {
        background: #4b5563;
      }
      .status {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        display: none;
      }
      .success {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #16a34a;
      }
      .progress {
        background: #dbeafe;
        color: #1d4ed8;
        border: 1px solid #3b82f6;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üßπ EcoLink Cache Emergency Clear</h1>

      <p>
        If you're seeing the old interface instead of the new one, use this tool to force clear all
        caches.
      </p>

      <div class="warning">
        <strong>‚ö†Ô∏è Warning:</strong> This will clear all cached data and you may need to log in
        again.
      </div>

      <button onclick="clearAllCaches()">üóëÔ∏è Clear All Caches</button>
      <button onclick="clearServiceWorkerOnly()" class="secondary">
        üîÑ Clear Service Worker Only
      </button>

      <div id="status" class="status">
        <div id="statusText"></div>
      </div>

      <hr style="margin: 30px 0" />

      <h3>Manual Steps (if automatic clearing doesn't work):</h3>
      <ol style="text-align: left">
        <li>Open Developer Tools (F12)</li>
        <li>Go to Application tab</li>
        <li>Click "Clear storage" in the left sidebar</li>
        <li>Check all boxes and click "Clear site data"</li>
        <li>Hard refresh (Ctrl+Shift+R or Cmd+Shift+R)</li>
      </ol>

      <button onclick="goHome()" class="secondary">üè† Go to Homepage</button>
    </div>

    <script>
      function showStatus(message, type = 'progress') {
        const status = document.getElementById('status')
        const statusText = document.getElementById('statusText')
        statusText.textContent = message
        status.className = `status ${type}`
        status.style.display = 'block'
      }

      async function clearAllCaches() {
        showStatus('üßπ Clearing all caches...', 'progress')

        try {
          // Clear service worker caches
          if ('caches' in window) {
            const names = await caches.keys()
            console.log('Found caches:', names)
            await Promise.all(names.map((name) => caches.delete(name)))
            showStatus('üì¶ Service worker caches cleared', 'progress')
          }

          // Unregister service workers
          if ('serviceWorker' in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations()
            await Promise.all(registrations.map((reg) => reg.unregister()))
            showStatus('üîÑ Service workers unregistered', 'progress')
          }

          // Clear storage
          if (typeof Storage !== 'undefined') {
            localStorage.clear()
            sessionStorage.clear()
            showStatus('üßΩ Storage cleared', 'progress')
          }

          // Clear IndexedDB
          if ('indexedDB' in window && indexedDB.databases) {
            const databases = await indexedDB.databases()
            await Promise.all(
              databases.map((db) => {
                return new Promise((resolve, reject) => {
                  const deleteReq = indexedDB.deleteDatabase(db.name)
                  deleteReq.onsuccess = () => resolve()
                  deleteReq.onerror = () => reject(deleteReq.error)
                })
              }),
            )
            showStatus('üóÑÔ∏è IndexedDB cleared', 'progress')
          }

          showStatus('‚úÖ All caches cleared! Reloading in 3 seconds...', 'success')

          setTimeout(() => {
            window.location.href = '/'
          }, 3000)
        } catch (error) {
          console.error('Error clearing caches:', error)
          showStatus('‚ùå Error clearing caches. Try manual steps below.', 'progress')
        }
      }

      async function clearServiceWorkerOnly() {
        showStatus('üîÑ Clearing service worker caches only...', 'progress')

        try {
          if ('caches' in window) {
            const names = await caches.keys()
            await Promise.all(names.map((name) => caches.delete(name)))
          }

          if ('serviceWorker' in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations()
            await Promise.all(registrations.map((reg) => reg.unregister()))
          }

          showStatus('‚úÖ Service worker cleared! Reloading...', 'success')

          setTimeout(() => {
            window.location.href = '/'
          }, 2000)
        } catch (error) {
          console.error('Error:', error)
          showStatus('‚ùå Error clearing service worker.', 'progress')
        }
      }

      function goHome() {
        window.location.href = '/'
      }
    </script>
  </body>
</html>
